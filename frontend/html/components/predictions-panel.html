<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Analytics - CTCT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .card-header {
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600;
        }
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .progress {
            border-radius: 4px;
        }
        .badge {
            padding: 6px 12px;
            font-weight: 500;
        }
        #enrollmentForecastChart {
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-chart-line text-primary"></i> Predictive Analytics Dashboard</h2>
                <p class="text-muted">ML-powered forecasts and risk predictions for clinical trial management</p>
            </div>
        </div>

        <!-- Model Performance Metrics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card text-center">
                    <div class="card-body">
                        <i class="fas fa-brain fa-2x text-success mb-2"></i>
                        <h6 class="text-muted">Dropout Model Accuracy</h6>
                        <h2 class="text-success" id="dropoutAccuracy">--</h2>
                        <p class="text-muted small mb-0">Based on training data</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h6 class="text-muted">Query Prediction MAE</h6>
                        <h2 class="text-info" id="queryMAE">--</h2>
                        <p class="text-muted small mb-0">Mean Absolute Error</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-bar fa-2x text-primary mb-2"></i>
                        <h6 class="text-muted">Predictions Made</h6>
                        <h2 class="text-primary" id="predictionsCount">--</h2>
                        <p class="text-muted small mb-0">Total predictions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enrollment Forecast Chart -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-users"></i> Enrollment Forecast</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="enrollmentForecastChart"></canvas>
                        <div id="forecastError" class="alert alert-warning mt-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="forecastErrorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- At-Risk Subjects -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> High Dropout Risk Subjects
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="atRiskLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading predictions...</p>
                        </div>
                        <div id="atRiskContent" style="display: none;">
                            <table class="table table-hover" id="atRiskTable">
                                <thead>
                                    <tr>
                                        <th>Subject ID</th>
                                        <th>Risk Probability</th>
                                        <th>Risk Level</th>
                                        <th>Confidence</th>
                                        <th>Top Driver</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="atRiskTableBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="atRiskError" class="alert alert-info" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span id="atRiskErrorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/predictions.js"></script>

    <script>
    $(document).ready(function() {
        loadEnrollmentForecast();
        loadAtRiskSubjects();

        // Set default model metrics (these would come from training results in production)
        $('#dropoutAccuracy').text('85%');
        $('#queryMAE').text('3.2 days');
    });

    async function loadEnrollmentForecast() {
        try {
            const data = await predictiveAI.getEnrollmentForecast('Study_1', 6);

            if (data.error) {
                $('#forecastError').show();
                $('#forecastErrorMessage').text(data.error);
                return;
            }

            renderEnrollmentChart(data);
        } catch (error) {
            console.error('Error loading forecast:', error);
            $('#forecastError').show();
            $('#forecastErrorMessage').text('Failed to load enrollment forecast');
        }
    }

    function renderEnrollmentChart(data) {
        const ctx = document.getElementById('enrollmentForecastChart').getContext('2d');

        // Combine historical and forecast data
        const historicalMonths = data.historical.map(d => d.month);
        const historicalCounts = data.historical.map(d => d.actual);

        const forecastMonths = data.forecast.map(d => d.month);
        const forecastCounts = data.forecast.map(d => d.predicted_enrollment);

        const allMonths = [...historicalMonths, ...forecastMonths];
        const historicalData = [...historicalCounts, ...Array(forecastMonths.length).fill(null)];
        const forecastData = [...Array(historicalMonths.length).fill(null), ...forecastCounts];

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: allMonths,
                datasets: [
                    {
                        label: 'Historical',
                        data: historicalData,
                        borderColor: '#0066CC',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Forecast',
                        data: forecastData,
                        borderColor: '#28A745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderDash: [5, 5],
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: `Average Monthly Rate: ${data.avg_monthly_rate} subjects`
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Subjects Enrolled'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    }

    async function loadAtRiskSubjects() {
        try {
            const data = await predictiveAI.getBatchRiskPredictions('Study_1', 10);

            $('#atRiskLoading').hide();

            if (!data.predictions || data.predictions.length === 0) {
                $('#atRiskError').show();
                $('#atRiskErrorMessage').text(
                    data.message ||
                    'No predictions available yet. Train ML models first by running: python manage.py train_ml_models'
                );
                return;
            }

            $('#atRiskContent').show();
            populateAtRiskTable(data.predictions);
            $('#predictionsCount').text(data.count);

        } catch (error) {
            console.error('Error loading at-risk subjects:', error);
            $('#atRiskLoading').hide();
            $('#atRiskError').show();
            $('#atRiskErrorMessage').text('Failed to load risk predictions');
        }
    }

    function populateAtRiskTable(predictions) {
        const tbody = $('#atRiskTableBody');
        tbody.empty();

        predictions.forEach(pred => {
            const riskBadge = getRiskBadgeClass(pred.risk_level);
            const topDriver = pred.top_drivers && pred.top_drivers.length > 0
                ? pred.top_drivers[0].feature
                : 'N/A';

            const row = `
                <tr>
                    <td><strong>${pred.subject_id}</strong></td>
                    <td>
                        <div class="progress" style="height: 24px;">
                            <div class="progress-bar bg-${riskBadge}"
                                 role="progressbar"
                                 style="width: ${(pred.risk_probability * 100).toFixed(0)}%">
                                ${(pred.risk_probability * 100).toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-${riskBadge}">${pred.risk_level}</span></td>
                    <td>${(pred.confidence * 100).toFixed(0)}%</td>
                    <td><small class="text-muted">${topDriver}</small></td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                onclick="viewSubjectDetails('${pred.subject_id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function getRiskBadgeClass(riskLevel) {
        const badges = {
            'Low': 'success',
            'Medium': 'warning',
            'High': 'danger',
            'Critical': 'danger'
        };
        return badges[riskLevel] || 'secondary';
    }

    function viewSubjectDetails(subjectId) {
        // Navigate to subject detail page
        alert(`View details for ${subjectId}\n\nThis would navigate to the subject detail page in production.`);
    }
    </script>
</body>
</html>
